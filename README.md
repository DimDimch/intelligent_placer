# Intelligent Placer
Лабораторная работа по курсу "Решение задач с семантическим разрывом"<p>
СПбПУ, осенний семестр 2022
***
## Формулировка задачи
На вход подается изображение нескольких различных предметов и многоугольник. Требуется определить, 
можно ли одновременно расположить данные предметы внутри заданного многоугольника.
## Формализация задачи
### 1. Входные данные

- Предметы и горизонтальная поверхность, которые могут оказаться на фотографии, должны быть заранее известны
- Предметы и многоугольник подаются на двух разных изображениях
- Предметы должны располагаться на белом листе бумаги формата А4 так, чтобы не перекрывать друг друга и не выходить за границы листа, однако допускается, что один предмет находится внутри другого
- Один предмет может присутствовать на фотографии только один раз
- Многоугольник должен быть задан замкнутым ломанным контуром, нарисованным черным маркером на белом листе бумаги формата А4
- Количество сторон многоугольника неограниченно, однако они должны быть явно различимы
- Разрешение всех фотографий, подаваемых на вход: 2048 х 1536 пикселей
- Допустимые форматы файлов: .jpeg, .png
- Высота съемки: 30-40 см.
- Угол наклона камеры относительно вертикальной оси: до 10°

### 2. Выходные данные
Должна быть возможность запуска алгоритма на всем тестовом наборе данных, а также для одного кейса

- После завершения работы основного алгоритма формируется файл с расширением .csv
- Каждая строчка этого файла содержит мета-информацию о пройденном кейсе, ссылки на входные данные и результат выполнения алгоритма: True - предметы на изображении способны поместиться в данный многоугольник; False - предметы на изображении не вмещаются в данный многоугольник
***
## План решения
Глобально задача делится на три основных этапа:
1. Идентификация объектов на изображении
2. Создание бинарных масок объектов, определение их площадей
3. Решение задачи (offline) укладки предметов

Первая задача подразумевает удаление лишнего фона на изображении, определение границ предметов и многоугольника, сопоставление с шаблонами.
Во второй задаче создаются бинарные маски многоугольника и предметов, вычисляются их площади. И в конце будет решаться задача комбинаторной оптимизации, 
известная как модификация задачи о ранце - задача offline (то есть, с заранее известным набором предметов) укладке.

### Подробнее об этапах решения 

- Предобработка для всех изображений
  - Сжатие изображения для увеличения скорости работы алгоритма
  - Переход от RGB к grayscale

- Определение положения белого листа бумаги
   - Применение детектора Canny для нахождения границ
   - Обрезать поверхность, оставив лист как замкнутый контур наибольшей площади

- Обнаружение многоугольника
  - Обнаружение границ с помощью детектора Canny
  - Заполнение внутренней части многоугольника
  - Создание инвертированной бинарной маски для многоугольника
  - Определение площади многоугольника

- Обнаружение предметов
  - Бинаризация изображения
  - Применение алгоритма Distance transform для получения маркеров объектов
  - Применение алгоритма Watershed для сегментации изображения
  - Поиск рабочих областей для каждого отдельного предмета
  - Поиск особых точек для каждого предмета детектором Харриса
  - Сопоставление с шаблонами с помощью дескриптора SIFT

- Укладка предметов в многоугольник
  - Сортировка объектов по площади и размерам 
  - Проверка необходимых критериев укладки (например, суммарная площадь)
  - Так как набор предметов заранее известен, а предметы, подаваемые на вход, идентифицированы, будет подготовлена метаинформация о наилучшем расположении предметов относительно друг друга (например, что можно один предмет поместить внутрь другого), а так же геометрический примитив, который лучше всего описывает предмет
  - Внутри многоугольника для каждого предмета, основываясь на его метаданных, будет создана сетка укладки - деление на прямоугольные области, куда можно уложить предмет
  - Далее будет происходить оптимизированный перебор всех вариантов укладки
  - В случае невозможности укладки после всех итераций, введя функцию оценки качества укладки (зависит от площади свободного места внутри прямоугольника, а так же площади предметов, вышедших за границы многоугольника), оценим необходимость для вызова дополнительного алгоритма доукладки, который на более мелкой сетке постарается более оптимально расположить предметы (немного сместив от текущего положения), после чего - возврат к основному алгоритму и повторная попытка укладки последних предметов

- Создание выходного файла result.csv 
  - С перечислением предметов на входном изображении и результатом работы алгоритма

### Возможные улучшения 
*TODO
