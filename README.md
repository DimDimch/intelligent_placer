# Intelligent Placer
Лабораторная работа по курсу "Решение задач с семантическим разрывом"<p>
СПбПУ, осенний семестр 2022
***
## Формулировка задачи
На вход подается изображение нескольких различных предметов и многоугольник. Требуется определить, 
можно ли одновременно расположить данные предметы внутри заданного многоугольника.
## Формализация задачи
### 1. Входные данные

- Предметы и горизонтальная поверхность, которые могут оказаться на фотографии, должны быть заранее известны
- Предметы и многоугольник подаются на двух разных изображениях
- Предметы должны располагаться на белом листе бумаги формата А4 так, чтобы не перекрывать друг друга и не выходить за границы листа, однако допускается, что один предмет находится внутри другого
- Один предмет может присутствовать на фотографии только один раз
- Многоугольник должен быть задан замкнутым ломанным контуром, нарисованным черным маркером на белом листе бумаги формата А4
- Количество сторон многоугольника неограниченно, однако они должны быть явно различимы
- Разрешение всех фотографий, подаваемых на вход: 2048 х 1536 пикселей
- Допустимые форматы файлов: .jpeg, .png
- Высота съемки: 30-40 см.
- Угол наклона камеры относительно вертикальной оси: до 10°

### 2. Выходные данные
Должна быть возможность запуска алгоритма на всем тестовом наборе данных, а также для одного кейса

- После завершения работы основного алгоритма формируется файл с расширением .csv
- Каждая строчка этого файла содержит мета-информацию о пройденном кейсе, ссылки на входные данные и результат выполнения алгоритма: True - предметы на изображении способны поместиться в данный многоугольник; False - предметы на изображении не вмещаются в данный многоугольник
***
## План решения
Глобально задача делится на три основных этапа:
1. Предобработка изображения
2. Идентификация предметов и многоугольника на изображении
3. Решение задачи (offline) укладки предметов в многоугольник

#### Некоторые дополнительные факты об алгоритме
- Идентификация объектов происходит с целью упрощения и улучшения качества работы алгоритма укладки
- Так как набор предметов заранее известен, а предметы, подаваемые на вход, идентифицированы, будет подготовлена метаинформация о предпочтительном (наилучшем) расположении предметов относительно друг друга (например, что можно один предмет поместить внутрь другого), а так же геометрический примитив (или не очень примитив), который лучше всего описывает предмет
- Сегментация изображения предметов призвана облегчить работу нейросети
- Контуры предметов будут направленные, по умолчанию - против часовой стрелки. Те предметы, которые полые внутри (скотч), имеют два контура, притом внутренний направлен по часовой стрелке. Направление используется для обхода по no-fit полигону (см. пункт 3)
- Круглые предметы будут аппроксимироваться правильными многоугольниками (наверное, 8-10 граней)
- В пункте 3 используется правило левого нижнего угла, строго говоря выбор правила остается открытой задачей. Возможно, будут проблемы при упаковке более крупных предметов

### 1. Предобработка изображений
Первая задача подразумевает удаление лишнего фона на изображении, отделение листа бумаги от фона и подготовку изображения для более быстрой и качественной обработки:
- Сжатие изображения для увеличения скорости работы алгоритма
- Переход от RGB к grayscale
- Применение детектора Canny для нахождения границ белого листа бумаги
- Обрезать поверхность, оставив лист как замкнутый контур наибольшей площади

### 2. Идентификация предметов и многоугольника
Во второй задаче изображение сегментируется на области, содержащие лишь один элемент (предмет или многоугольник), идентификация объекта происходит с помощью сверточной нейронной сети.

#### 2.1. Сегментация изображения с предметами
- Бинаризация
- Применение алгоритма Distance transform для получения маркеров объектов
- Применение алгоритма Watershed для сегментации изображения
- Поиск рабочих областей для каждого отдельного предмета

#### 2.2. Обнаружение многоугольника
- Обнаружение границ с помощью детектора Canny
- Заполнение внутренней части многоугольника
- Определение площади многоугольника

#### 2.3. Обнаружение предметов
Дле детекции предметов будем использовать алгоритм YOLOv3 (скорее всего облегченная версия)
- увеличение обучающей выборки с помощью нескольких методов аугментации
- объединение оригинальных изображений с результатом аргументации
- разметка объектов с помощью программы labelImg
- разделение выборки на обучающую и тестовую
- в отдельном файле указываем количество классов и именования предметов
- дообучаем сверточную нейросеть
- возвращаем список распознанных предметов

### 3. Укладка предметов в многоугольник
В конце будет решаться задача комбинаторной оптимизации, известная как модификация задачи о ранце - задача offline 
(то есть, с заранее известным набором предметов) укладке посредством нескольких алгоритмических приемов.

- Проверка необходимых критериев укладки (например, суммарная площадь)
- Если необходимые условия не сработали, то переходим к основному алгоритму укладки, в основе которого - жадный алгоритм, суммы Минковского и алгоритм доупаковки:
  - Шаг 1. Сортируем объекты по площади (как именно - открытый вопрос, следует посмотреть на результаты, когда мы подаем предметы по возрастанию площади, убыванию площади и в рандомном порядке)
  - Шаг 2. Выстраиваем первый объект по эвристическому жадному правилу левого нижнего угла (greedy bottom-left rule)
  - Шаг 3. Устанавливаем i = 1
  - Шаг 4. Вычисляем no-fit polygon для предметов i и (i - 1) с помощью сумму Минковского
  - Шаг 5. Располагаем i-й объект по правилу левого нижнего угла, если расположить предмет невозможно, переходим к алгоритму доукладки
  - Шаг 6. Если кончились предметы, возвращаем True, иначе i = i + 1 и переходим к шагу 4
- Если жадный алгоритм не смог уложить все предметы - применяем алгоритм доупаковки (пока в разработке):
  - Можно начать немного двигать предметы, что-то вроде тряски
  - Можно использовать полученный результат, как начальный вектор для работы генетического алгоритма

### Создание выходного файла result.csv 
- С перечислением предметов на входном изображении и результатом работы алгоритма
